#!/usr/bin/env ruby

require 'rubygems'
require 'sequel'
require 'dotenv'

ROOT = File.join(File.dirname(__FILE__), '..')
Dotenv.load(File.join(ROOT, '.env'))

DB   = Sequel.sqlite(File.join(ROOT, 'db', "#{ENV['RACK_ENV']}.sqlite3"))
TIME = Time.now - (ENV['PURGE'].to_i * 86400)

DB[:items].where('created_at <= ?', TIME).all.each do |item|
  system("curl -X DELETE '#{ENV['SHORT']}/api?token=#{ENV['TOKEN']}&slug=#{item[:slug]}' &> /dev/null")
end
